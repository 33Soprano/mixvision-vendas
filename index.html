<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MixVision | Dashboard de Vendas</title>

    <!-- Firebase SDK (para autenticação) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLsmYJ87CACLUPltpznb94cvvAR4zs5dI",
            authDomain: "banco-de-dados-mixvendas.firebaseapp.com",
            projectId: "banco-de-dados-mixvendas",
            storageBucket: "banco-de-dados-mixvendas.firebasestorage.app",
            messagingSenderId: "510513816274",
            appId: "1:510513816274:web:f5fb07db566e080aad830b",
            measurementId: "G-XGWFJK55DL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const analytics = getAnalytics(app);

        window.firebaseApp = app;
        window.firebaseDb = db;

        console.log("✅ Firebase configurado!");
    </script>

    <!-- Supabase SDK (para planilhas) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Configuração do Supabase para planilhas
        const supabaseUrl = 'https://llcewofzmpyczwfoljem.supabase.co';
        const supabaseAnonKey = 'sb_publishable_NPgqokxNKRJ_nxIFY-zKuA_PTsrEvIQ';

        window.supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);
        console.log("✅ Supabase configurado para planilhas!");
    </script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="style.css">

    <style>
        /* Estilos específicos para telas */
        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: block;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .mt-4 {
            margin-top: 16px;
        }

        .mb-4 {
            margin-bottom: 16px;
        }

        .mr-2 {
            margin-right: 8px;
        }

        .text-xs {
            font-size: 12px;
        }

        .font-semibold {
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay Global -->
    <div id="global-loading" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="text-secondary mt-4" id="loading-message">Processando...</p>
    </div>

    <!-- Toast Message -->
    <div id="toast-message" class="toast-message"></div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="screen active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo">
                    <h1>MixVision</h1>
                    <p>Acesse com seu token de vendedor</p>
                </div>

                <div class="login-steps">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <span>Digite seu token</span>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <span>Escolha uma planilha</span>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <span>Veja suas oportunidades</span>
                    </div>
                </div>

                <form class="login-form">
                    <div class="form-group">
                        <label for="token-input">Seu Token</label>
                        <input type="password" id="token-input" class="form-control" placeholder="Ex: ABC123XYZ"
                            maxlength="20" autocomplete="off">
                    </div>
                    <button type="submit" id="login-btn" class="btn-login btn-primary">
                        <i class="fas fa-arrow-right"></i>
                        Acessar Dashboard
                    </button>
                </form>

                <div id="error-msg" class="error-msg">
                    <i class="fas fa-exclamation-circle"></i> Token inválido ou expirado!
                </div>

                <div class="footer-note">
                    <i class="fas fa-info-circle"></i>
                    Token admin: <strong>admin-123</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD ADMIN -->
    <div id="admin-screen" class="screen">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-user-shield"></i>
                        Painel Administrativo
                    </h1>
                    <p class="subtitle">Gerenciamento de Vendedores e Planilhas</p>
                </div>
                <div class="header-right">
                    <div class="user-welcome">
                        <div class="user-avatar" id="user-avatar">A</div>
                        <div>
                            <div id="user-name" class="user-name">Administrador</div>
                            <div id="user-role" class="user-role">ADMIN</div>
                        </div>
                    </div>
                    <button onclick="mixLogout()" class="btn-logout btn-primary">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </header>

            <!-- ADMIN: Cadastrar Vendedor -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-user-plus"></i> Cadastrar Novo Vendedor</h3>
                    <p>Crie tokens para novos vendedores</p>
                </div>
                <div class="form-row">
                    <div class="form-group flex-1">
                        <label for="new-user-name">Nome do Vendedor</label>
                        <input type="text" id="new-user-name" class="form-control" placeholder="Ex: João Silva">
                    </div>
                    <button id="create-user-btn" onclick="mixCreateUser()" class="btn-primary mt-4">
                        <i class="fas fa-plus"></i> Gerar Token
                    </button>
                </div>
            </div>

            <!-- ADMIN: Gerenciar Planilhas -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-layer-group"></i> Gerenciar Planilhas</h3>
                    <p>Gerencie múltiplas planilhas por categoria</p>
                </div>

                <div class="spreadsheet-selector-header">
                    <button onclick="showAddSpreadsheetModal()" class="btn-primary">
                        <i class="fas fa-plus-circle mr-2"></i> Adicionar Planilha
                    </button>
                </div>

                <div id="spreadsheets-list" class="spreadsheet-grid mt-6">
                    <div class="loading-card p-8 text-center">
                        <div class="spinner"></div>
                        <p class="mt-4 text-secondary">Carregando planilhas do Supabase...</p>
                    </div>
                </div>
            </div>

            <!-- ADMIN: Vendedores Cadastrados -->
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-users"></i> Vendedores Cadastrados</h3>
                    <p>Lista de vendedores com seus tokens</p>
                </div>
                <div id="users-container" class="users-grid">
                    <div class="loading-card p-8 text-center">
                        <div class="spinner"></div>
                        <p class="mt-4 text-secondary">Carregando vendedores...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD VENDEDOR -->
    <div id="dashboard-screen" class="screen">
        <div class="app-container">
            <header class="app-header">
                <div class="header-left">
                    <h1>
                        <i class="fas fa-chart-line"></i>
                        MixVision Dashboard
                    </h1>
                    <p class="subtitle" id="spreadsheet-help">Selecione uma planilha para analisar oportunidades</p>
                </div>
                <div class="header-right">
                    <div class="user-welcome" id="user-welcome">
                        <div class="user-avatar" id="dashboard-user-avatar">V</div>
                        <div>
                            <div id="dashboard-user-name" class="user-name">Vendedor</div>
                            <div id="dashboard-user-role" class="user-role">VENDEDOR</div>
                        </div>
                    </div>
                    <button onclick="mixLogout()" class="btn-logout btn-primary">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </header>

            <!-- SEÇÃO: Seleção de Planilha -->
            <section id="spreadsheet-selector" class="card">
                <div class="spreadsheet-selector-header">
                    <div>
                        <h3><i class="fas fa-file-alt mr-2"></i> Selecione a Planilha</h3>
                        <p class="text-secondary">Escolha qual categoria de dados você quer analisar:</p>
                    </div>
                    <div class="category-filters" id="category-filters">
                        <button class="category-filter-btn all active" onclick="filterSpreadsheets('all')">
                            <i class="fas fa-th"></i> Todas
                        </button>
                        <button class="category-filter-btn mercearia" onclick="filterSpreadsheets('mercearia')">
                            <i class="fas fa-store"></i> Mercearia
                        </button>
                        <button class="category-filter-btn limpeza" onclick="filterSpreadsheets('limpeza')">
                            <i class="fas fa-broom"></i> Limpeza
                        </button>
                        <button class="category-filter-btn mdias" onclick="filterSpreadsheets('mdias')">
                            <i class="fas fa-calendar-day"></i> M Dias
                        </button>
                        <button class="category-filter-btn saudaveis" onclick="filterSpreadsheets('saudaveis')">
                            <i class="fas fa-apple-alt"></i> Saudáveis
                        </button>
                    </div>
                </div>

                <div class="spreadsheet-grid" id="spreadsheet-cards">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <h4>Aguarde carregamento</h4>
                        <p>Carregando planilhas do Supabase...</p>
                    </div>
                </div>

                <div id="no-spreadsheets" class="hidden text-center py-12">
                    <div class="empty-state-icon">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <h4>Nenhuma planilha disponível</h4>
                    <p>Aguarde o administrador adicionar planilhas.</p>
                </div>
            </section>

            <!-- SEÇÃO: Dados da Planilha Selecionada -->
            <section id="data-section" class="card hidden">
                <div id="selected-spreadsheet-header"></div>

                <!-- Status e Estatísticas -->
                <div id="data-status-area">
                    <div class="stats-grid mb-8">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-consultants">0</div>
                            <div class="stat-label">Consultores</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-clients">0</div>
                            <div class="stat-label">Clientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-products">0</div>
                            <div class="stat-label">Produtos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-opportunities">0</div>
                            <div class="stat-label">Oportunidades</div>
                        </div>
                    </div>
                </div>

                <!-- Filtros e Análise -->
                <section id="filters-section" class="hidden">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label><i class="fas fa-user-tie mr-2"></i>Consultor</label>
                            <select id="consultant-select" class="form-control">
                                <option value="">Selecionar consultor...</option>
                            </select>
                        </div>
                        <div id="route-group" class="form-group">
                            <label><i class="fas fa-route mr-2"></i>Rota</label>
                            <select id="route-select" class="form-control" disabled>
                                <option value="">Selecione primeiro o consultor</option>
                            </select>
                        </div>
                        <div id="client-group" class="form-group">
                            <label><i class="fas fa-building mr-2"></i>Cliente</label>
                            <select id="client-select" class="form-control" disabled>
                                <option value="">Selecione primeiro a rota</option>
                            </select>
                        </div>
                    </div>

                    <!-- Abas -->
                    <div class="tabs-container">
                        <button id="tab-opportunities" class="tab-button active">
                            <i class="fas fa-bullseye mr-2"></i>Oportunidades
                        </button>
                        <button id="tab-sold" class="tab-button">
                            <i class="fas fa-check-circle mr-2"></i>Já Vendidos
                        </button>
                    </div>

                    <!-- Contador -->
                    <div class="opportunity-count">
                        <div>
                            <div class="count-label" id="results-title">OPORTUNIDADES DE VENDA</div>
                            <div class="count-display" id="opportunity-count-text">0 itens</div>
                        </div>
                        <div class="badge-container">
                            <div class="badge badge-profile" id="profile-badge">Perfil: N/D</div>
                            <button id="btn-export" class="btn-primary" style="display: none;">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Lista de Oportunidades -->
                    <div id="opportunities-list" class="opportunity-grid"></div>

                    <!-- Estado Vazio -->
                    <div id="empty-state" class="empty-state hidden">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <h4>Nenhum dado para exibir</h4>
                        <p>Selecione um consultor, rota e cliente para visualizar as oportunidades</p>
                    </div>
                </section>

                <!-- Mensagem de Carregamento -->
                <div id="data-loading" class="text-center py-12">
                    <div class="spinner"></div>
                    <p class="text-secondary mt-4">Carregando dados da planilha...</p>
                </div>

                <!-- Mensagem de Erro -->
                <div id="data-error" class="hidden error-state">
                    <h4><i class="fas fa-exclamation-triangle mr-2"></i>Erro ao carregar dados</h4>
                    <p id="error-message">Não foi possível carregar a planilha selecionada.</p>
                    <button id="btn-retry" class="btn-primary mt-4">
                        <i class="fas fa-redo mr-2"></i>Tentar Novamente
                    </button>
                </div>
            </section>

            <!-- Console do Sistema COM BOTÃO DE TESTE -->
            <section class="card">
                <div class="card-header">
                    <h3><i class="fas fa-terminal"></i> Console do Sistema</h3>
                    <p>Logs de debug e informações do sistema</p>
                </div>
                <div class="console-controls">
                    <button id="btn-clear-log" class="btn-primary">
                        <i class="fas fa-broom"></i> Limpar Logs
                    </button>
                    <!-- BOTÃO DE TESTE ADICIONADO AQUI -->
                    <button id="btn-test-link" class="btn-primary" style="background: #3b82f6;">
                        <i class="fas fa-vial"></i> Testar Link OneDrive
                    </button>
                    <button onclick="debugPlanilha()" class="btn-primary" style="background: #8b5cf6;">
                        <i class="fas fa-bug"></i> Debug Planilha
                    </button>
                </div>
                <div class="log-container">
                    <pre id="debug-log"></pre>
                </div>
            </section>
        </div>
    </div>

    <script src="script.js"></script>

    <script>
        // Funções auxiliares globais
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) screen.classList.add('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-msg');
            if (errorDiv) {
                errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
                errorDiv.style.display = 'block';
            }
        }

        function hideError() {
            const errorDiv = document.getElementById('error-msg');
            if (errorDiv) errorDiv.style.display = 'none';
        }

        // Login com Enter
        document.getElementById('token-input')?.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') mixLogin();
        });

        // Auto-focus no input do token
        document.addEventListener('DOMContentLoaded', function () {
            const tokenInput = document.getElementById('token-input');
            if (tokenInput) tokenInput.focus();
        });

        // Form submit
        document.querySelector('.login-form')?.addEventListener('submit', function (e) {
            e.preventDefault();
            mixLogin();
        });
    </script>
</body>

</html>
